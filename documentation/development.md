# Development Guide

## Setting Up Development Environment

### Prerequisites

- Python 3.12+
- Docker Engine
- Docker Compose V2
- Git

### Clone and Install

```bash
git clone https://github.com/MarkTarry/HomeAssistant-Test-Harness.git
cd HomeAssistant-Test-Harness
pip install -e ".[dev]"
```

This installs the package in editable mode with all development dependencies.

### Install Pre-commit Hooks

```bash
pre-commit install
```

This ensures code quality checks run automatically before each commit.

## Running Checks

### All Pre-commit Hooks

```bash
pre-commit run --all-files
```

### Individual Tools

```bash
# Format code
black src/

# Sort imports
isort src/

# Lint
flake8 src/

# Type check
mypy src/

# Lint YAML
yamllint .

# Lint Markdown
markdownlint_docker --style .markdownlint_style.rb .
```

## Building the Package

### Build Distribution

```bash
python -m build
```

This creates wheel and source distributions in `dist/`.

### Test Installation

```bash
pip install dist/ha_integration_test_harness-*.whl
python -c "import ha_integration_test_harness; print(ha_integration_test_harness.__version__)"
```

## Running Example Tests

The `examples/` directory contains runnable tests:

```bash
pytest examples/
```

**Note:** Examples require a minimal Home Assistant configuration in `examples/config/`.

## Using Editable Install in Another Project

When developing the harness, you can use it in your Home Assistant configuration repository:

```bash
# In your HomeAssistant configuration repository
pip install -e /path/to/HomeAssistant-Test-Harness

# Run your integration tests
pytest integration_tests/
```

This allows you to:

- Make changes to the harness code
- Test changes immediately without reinstalling
- Develop features while testing against real configuration

## Version Bumping

### Update Version

Version is defined in two places and must be updated together:

1. **pyproject.toml**: Update the `version` field

   ```toml
   [project]
   version = "0.2.0"
   ```

2. **src/ha_integration_test_harness/__init__.py**: Update `__version__`

   ```python
   __version__ = "0.2.0"
   ```

### Semantic Versioning

Follow [semantic versioning](https://semver.org/):

- **Major** (1.0.0): Breaking changes to fixtures or API
- **Minor** (0.2.0): New features, backward compatible
- **Patch** (0.1.1): Bug fixes, backward compatible

### Version Bump Examples

- Fixture signature changes: **Major**
- New fixture added: **Minor**
- Docker configuration improvements: **Minor**
- Bug fix in API client: **Patch**
- Documentation updates: **Patch**

## Creating Releases

### Process

1. **Update version** in `pyproject.toml` and `__init__.py`
2. **Commit changes**:

   ```bash
   git add pyproject.toml src/ha_integration_test_harness/__init__.py
   git commit -m "Bump version to 0.2.0"
   git push
   ```

3. **Create release via GitHub Actions**:
   - Go to Actions → "Create Release"
   - Click "Run workflow"
   - Choose whether to publish immediately or create draft
   - Workflow generates timestamp-based tag: `yyyy-mm-dd@HH-MM-ss`

### Release Tag Format

Releases use timestamp tags (e.g., `2026-01-21@14-30-00`) automatically generated by the workflow.

### After Release

- GitHub automatically generates release notes
- Users can install specific release: `pip install git+https://github.com/MarkTarry/HomeAssistant-Test-Harness.git@2026-01-21@14-30-00`

## Code Style

### Python

- **Line length**: 200 characters
- **Formatter**: Black
- **Import sorting**: isort (black profile)
- **Type hints**: Required for all public APIs
- **Docstrings**: Google style

### YAML

- **Indentation**: 2 spaces
- **Line length**: 200 characters
- **No trailing whitespace**

### Markdown

- **Line length**: 200 characters
- **List indentation**: 2 spaces
- **Ordered lists**: sequential numbering

## Project Structure

```
HomeAssistant-Test-Harness/
├── src/ha_integration_test_harness/  # Package source
│   ├── __init__.py                    # Public API exports
│   ├── conftest.py                    # Pytest plugin fixtures
│   ├── docker_manager.py              # Docker orchestration
│   ├── homeassistant_client.py        # HA API client
│   ├── appdaemon_client.py            # AppDaemon client
│   ├── time_machine.py                # Time manipulation
│   ├── exceptions.py                  # Exception hierarchy
│   └── containers/                    # Docker configurations
│       ├── docker-compose.yaml
│       ├── homeassistant/             # HA setup scripts
│       ├── appdaemon/                 # AppDaemon setup
│       └── libfaketime/               # Time manipulation
├── examples/                          # Example tests
│   ├── test_basic_usage.py
│   └── config/                        # Minimal HA config
├── documentation/                     # User documentation
├── .github/workflows/                 # CI/CD pipelines
├── pyproject.toml                     # Package metadata
└── README.md                          # Project overview
```

## Contributing Guidelines

See [CONTRIBUTING.md](../CONTRIBUTING.md) for:

- Code of conduct
- How to submit issues
- Pull request process
- Testing requirements

## CI/CD

### Continuous Integration

The CI workflow runs on every push and pull request:

1. Installs dependencies
2. Runs pre-commit hooks
3. Builds package
4. Validates package imports

### Release Workflow

Manual trigger creates timestamped release with auto-generated notes.

## Next Steps

- Review [CONTRIBUTING.md](../CONTRIBUTING.md)
- Check [GitHub Issues](https://github.com/MarkTarry/HomeAssistant-Test-Harness/issues) for tasks
- Join discussions in issue tracker
