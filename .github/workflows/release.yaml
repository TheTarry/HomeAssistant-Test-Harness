---
name: Create Release

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.0)'
        required: true
        type: string
      publish:
        description: 'Publish the release (uncheck for draft)'
        required: true
        type: boolean
        default: true

jobs:
  create_release:
    runs-on: ubuntu-latest
    name: üì¶ Create Release
    permissions:
      contents: write
    steps:
      - name: üîë Authenticate as Release Manager
        id: release-manager-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.RELEASE_MANAGER_APP_ID }}
          private-key: ${{ secrets.RELEASE_MANAGER_PRIVATE_KEY }}

      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ steps.release-manager-token.outputs.token }}

      - name: ÔøΩ Set up Python and uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: üîç Check if release already exists
        run: |-
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "::error::Release $TAG already exists"
            exit 1
          fi

          echo "Release $TAG does not exist, proceeding with creation"

      - name: üìù Update version in all files
        run: |-
          VERSION="${{ inputs.version }}"
          echo "Updating version to $VERSION in pyproject.toml and uv.lock"

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

          # Regenerate uv.lock with new version
          uv lock

          # Commit all changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml uv.lock

          if git diff --staged --quiet; then
            echo "Version is already set to $VERSION, skipping commit"
          else
            git commit -m "Bump version to $VERSION"
            git push
          fi

      - name: üöÄ Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ steps.release-manager-token.outputs.token }}
        run: |-
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"
          DRAFT_FLAG=""

          if [ "${{ inputs.publish }}" = "false" ]; then
            DRAFT_FLAG="--draft"
            echo "Creating draft release with tag: $TAG"
          else
            echo "Creating published release with tag: $TAG"
          fi

          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes \
            $DRAFT_FLAG
